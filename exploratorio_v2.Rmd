---
title: "MODIS"
output: html_document
---

<!--
http://r-gis.net/?q=ModisDownload

Cuenta: mortiz
31...
-->

The MODIS tiled Land products are generated by the MODIS Adaptive Processing 
System (MODAPS), located at the NASA Goddard Space Flight Center, as gridded 
output in the Sinusoidal (SIN) projection. These data products are then sent to 
the LP DAAC for archive and distribution.

MRT enables users to read data files in HDF-EOS format (MODIS Level-2G, Level-3, and Level-4 land data products), specify a geographic subset or specific science data sets as input to processing, perform geographic transformation to a different coordinate system/cartographic projection, and write the output to file formats other than HDF-EOS.

The MODIS Reprojection Tool is available for use by all registered users. The
MODIS Tool will undergo further development to correct problems as they are
detected, incorporate additional functionality, and be modified to enhance
computational performance. The funding support for this work comes from the 
NASA Earth Science Data and Information Systems (ESDIS) Project.

Product: [MOD17A2](https://lpdaac.usgs.gov/products/modis_products_table/mod17a2)

Value | Description
------|--------------
32767 | Fillvalue
32766 | land cover assigned as perennial salt or inland fresh water
32765 | land cover assigned as barren, sparse vegetation (rock, tundra, desert.)
32764 | land cover assigned as perennial snow, ice
32763	| land cover assigned as "permanent" wetlands/inundated marshlands
32762	| land cover assigned as urban/built-up
32761	| land cover assigned as "unclassified" or not able to determine



```{r, message=FALSE, warning=FALSE}
# Packages and data
library(lubridate)
library(stringr)
library(raster)
library(plyr)
library(dplyr)
library(tidyr)
library(Hmisc)
library(ggplot2)
library(fda)
library(depmixS4)
library(Rgraphviz)
source("src/tema_ggplot.R")
source("src/functions.R")
load("data/df_npp.RData")
```

# Spatial and temporal dependency

Explore NPP vs $x$ and $y$ coordinates, this only checks for very simple spatial
dependencies.

```{r, message=FALSE, warning=FALSE}
ggplot(df_npp, aes(x = x, y = npp, color = year)) +
  geom_point(size = 0.5, aplha = 0.3) + geom_smooth()

ggplot(df_npp, aes(x = y, y = npp, color = year)) +
  geom_point(size = 0.5, alpha = 0.3) + geom_smooth()

```


```{r}
years <- filter(df_npp, month == 1, week == 1) %>% 
  select(date) %>%
  unique()

ggplot(sample_n(df_npp, 50000)) +
  geom_line(aes(x = date, y = npp, group = .id), alpha = 0.05,
            show_guide = FALSE) +
  geom_smooth(aes(x = date, y = npp), color = "red", span = 0.05, 
              method = "loess") +
  geom_vline(xintercept = as.numeric(years$date), color = "blue", alpha = 0.1) +
  theme(panel.grid = element_blank())
```

opipok
Partition the area in $5 \times 5$ rectangles:

```{r, message=FALSE, warning=FALSE, fig.width=10, fig.height=10}
ggplot(sample_n(df_npp, 30000)) +
  geom_line(aes(x = date, y = npp, group = .id), alpha = 0.1,
            show_guide = FALSE) +
  geom_smooth(aes(x = date, y = npp), color = "red", span = 0.05, 
              method = "loess") +
  facet_grid(x_cat ~ y_cat) +
  geom_vline(xintercept = as.numeric(years$date), color = "blue", alpha = 0.1) +
  theme(panel.grid = element_blank())

```

Maps

```{r, fig.height=20}
df_npp_year <- df_npp %>%
  group_by(x, y, .id, year) %>%
  summarise(
    min_npp = min(npp), 
    max_npp = max(npp)
    ) %>%
  gather(var, value, min_npp, max_npp)
  
ggplot(df_npp_year, aes(x = x, y = y, fill = value)) +
  geom_tile() + facet_grid(year ~ var)
```


```{r}
# Include 2nd degree polynomial of centered coords
df_npp <- mutate(df_npp, x_std = scale(x)[, 1], y_std = scale(y)[, 1])
P <- createPoly(x = df_npp$x_std, 
                y = df_npp$y_std, d = 2)
fit_npp <- lm(
  npp ~ -1 + factor(month(date)) + factor(year) + P, 
  data = df_npp)
summary(fit_npp)
```


B-splines to account for within year seasonality and across years trend:

```{r}
# trend
basis_y <- create.bspline.basis(
  norder = 4, # polinomios cúbicos
  breaks = c(2000, 2005, 2009, 2014)) # nodos en los cuartiles de x

# basis
plot(basis_y, lty = "solid")
H_y <- eval.basis(df_npp$year, basis_y)
colnames(H_y) <- paste("sp_y", 1:6, sep = "_")

df_sp <- data.frame(npp = df_npp$npp, H_y)
fit_sp_y <- lm(npp ~ -1 + ., data = df_sp)
summary(fit_sp_y)

mu <- function(x, betas, basis){
  as.numeric(betas %*% t(eval.basis(x, basis)))
}

coefs <- summary(fit_sp_y)$coefficients
coefs_y <- as.vector(coefs[str_detect(rownames(coefs), "sp_y"), ][, 1])

ggplot(df_npp, aes(x = year, y = npp, color = factor(year))) +
  geom_point(size = 0.5) + 
  stat_function(fun = mu, arg = list(betas = coefs_y, basis = basis_y), 
                color = "blue") +
  labs(title = "B-splines")

df_npp$resid_y <- residuals(fit_sp_y)

df_sp_plot <- df_npp %>% 
  select(npp, resid_y, date) %>%
  gather(var, value, npp, resid_y)

ggplot(df_sp_plot, aes(x = date, y = value, group = var)) +
  geom_line(alpha = 0.3) +
  facet_wrap(~ var, ncol = 1, scales = "free_y") +
  geom_smooth(color = "red", n = 200)

```


```{r}
##### B-splines
# monthly seasonality
basis_m <- create.bspline.basis(
  # norder = 4, # polinomios cúbicos
  breaks = seq(1, 52, 3) # nodos en los cuartiles de x
    )
# basis
plot(basis_m, lty = "solid")
H_m <- eval.basis(df_npp$week, basis_m)
colnames(H_m) <- paste("sp_m", 1:20, sep = "_")

df_sp_m <- data.frame(npp = df_npp$npp, H_m)
fit_sp_m <- lm(npp ~ -1 + ., data = df_sp_m)
summary(fit_sp_m)

coefs_m <- summary(fit_sp_m)$coefficients
coefs_m <- as.vector(coefs_m[str_detect(rownames(coefs_m), "sp_m"), ][, 1])

# mu: function to creat spline curve
mu <- function(x, betas, basis){
  as.numeric(betas %*% t(eval.basis(x, basis)))
}

ggplot(df_npp, aes(x = week, y = npp, color = factor(year))) +
  geom_point(size = 0.5, alpha = 0.4) + 
  stat_function(fun = mu, arg = list(betas = coefs_m, basis = basis_m), 
                color = "blue") +
  labs(title = "B-splines")

##
df_npp$resid <- residuals(fit_sp_m)

df_sp_plot <- df_npp %>% 
  select(npp, resid, date) %>%
  gather(var, value, npp, resid)

ggplot(df_sp_plot, aes(x = date, y = value)) +
  geom_line(alpha = 0.3) +
  facet_wrap(~ var, ncol = 1, scales = "free_y") +
  geom_smooth(color = "red", span = 0.02)

```

## LOESS

```{r}

npp_12 <- filter(df_npp, year > 2001, year < 2006, .id == "3804500_1008500")
ts_np <- ts(npp_12$npp, frequency = 46)
decomposed <- stl(ts_np, s.window="periodic")
plot(decomposed)

npp_12$remainder  <- decomposed$time.series[,3]
```

```{r}
npp_12 <- filter(df_npp, year %in% c(2004, 2006, 2008, 2010, 2012), month == 6)

ggplot(npp_12, aes(x = x, y = y, fill = npp)) +
  geom_tile() + facet_wrap(~year, nrow = 2)
```


### Monthly measurements

```{r}
df_npp_month <- df_npp %>%
  group_by(x, y, year, .id, month) %>%
  summarise(
    date = min(date),
    min_npp = min(npp), 
    max_npp = max(npp),
    mean_npp = mean(npp)
    ) %>%
  ungroup()

df_npp_plot <- df_npp_month %>%
  gather(var, value, min_npp, max_npp, mean_npp)

ggplot(df_npp_plot) +
  geom_line(aes(x = date, y = value, group = .id, color = x), alpha = 0.05) + 
  facet_wrap(~ var, nrow = 3) # +
  #  geom_smooth(aes(x = date, y = value), color = "red", span = 0.05, 
  #             method = "loess") 
```

### HMM over monthly averages

```{r}
# 1. Model specification
# ntimes: 1421 sequences with 175 observations each:
# model 5 states
mod_5s <- depmix(mean_npp ~ x + y, data = df_npp_month, nstates = 5, 
  family = gaussian(), ntimes = rep(175,1421))
# 2. Model fitting
# initial values for EM algorithm
mod_5s 
fit_5s <- fit(mod_hmm,  emcontrol = em.control(maxit = 200))
summary(fit_5s)

# Posterior
dim(fit_5s@posterior)
```

